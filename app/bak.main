#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# main.py
import time
import logging
import sys

from transport import create_transport, BaseTransport
from publisher import get_publisher
from decoder import decode_packet, extract_device_address


def setup_logging(debug_raw: bool) -> None:
    """
    è¨­å®š logging æ ¼å¼èˆ‡ç­‰ç´šã€‚

    debug_raw = True æ™‚ï¼Œè¼¸å‡º DEBUGï¼ˆæœƒçœ‹åˆ°è§£æç´°ç¯€ã€raw logï¼‰
    å¦å‰‡åªé¡¯ç¤º INFO ä»¥ä¸Šï¼ˆåªçœ‹åˆ°é—œéµäº‹ä»¶ï¼‰ã€‚
    """
    level = logging.DEBUG if debug_raw else logging.INFO
    logging.basicConfig(
        level=level,
        format="%(asctime)s [%(levelname)s] %(message)s",
        datefmt="%H:%M:%S",
        stream=sys.stdout,
    )


logger = logging.getLogger("jk_bms_main")


def main():
    # å»ºç«‹é€šè¨Šå±¤ï¼ˆTCP or RS485ï¼‰
    transport: BaseTransport = create_transport()
    # å»ºç«‹ MQTT ç™¼ä½ˆå™¨
    publisher = get_publisher(config_path="/data/config.yaml")

    # å¾ config è£¡æ‹¿åˆ°è¨­å®š
    app_cfg = getattr(transport, "app_cfg", {}) or {}
    PACKET_EXPIRE_TIME = float(app_cfg.get("packet_expire_time", 0.4))
    debug_raw_log = bool(app_cfg.get("debug_raw_log", False))

    # å•Ÿå‹• logging
    setup_logging(debug_raw_log)

    # 0x02 ç¶å®šé‚è¼¯æš«å­˜
    pending_realtime_packet = None
    last_realtime_time = 0.0

    logger.info("ğŸš€ JiKong BMS main å•Ÿå‹•ï¼Œé–‹å§‹è™•ç†å°åŒ…...")

    # æŒçºŒå¾ transport æ”¶ (packet_type, raw_bytes)
    for pkt_type, packet in transport.packets():
        try:
            if pkt_type == 0x02:
                # å…ˆæš«å­˜ï¼Œç­‰ 0x01 ä¾†è£œ ID
                if pending_realtime_packet is not None:
                    logger.debug("ä¸Šä¸€ç­† 0x02 å°šæœªç­‰åˆ° 0x01ï¼Œå°±å·²è¢«è¦†è“‹")
                pending_realtime_packet = packet[:]
                last_realtime_time = time.time()
                # é€™è¡Œåªåœ¨ debug æ¨¡å¼çœ‹å¾—åˆ°
                logger.debug("æ”¶åˆ° 0x02 å³æ™‚æ•¸æ“šï¼Œå·²æš«å­˜ç­‰å¾… 0x01")

            elif pkt_type == 0x01:
                # è§£æè¨­å‚™ IDï¼ˆè©³ç´°è§£æè¨Šæ¯ç§»åˆ° DEBUGï¼‰
                device_id = extract_device_address(packet)
                logger.debug(
                    "æ”¶åˆ° 0x01 è¨­å®šå°åŒ…ï¼Œè§£æå¾—åˆ° device_id = %d (0x%x)",
                    device_id,
                    device_id,
                )

                # è§£ç¢¼ä¸¦ç™¼ä½ˆè¨­å®š (publisher å…§å·²åšç¯€æµ & éœéŸ³)
                settings_payload = decode_packet(packet, 0x01)
                publisher.publish_payload(device_id, 0x01, settings_payload)

                # è™•ç†ä¹‹å‰æš«å­˜çš„ 0x02
                if pending_realtime_packet:
                    time_diff = time.time() - last_realtime_time
                    if time_diff < PACKET_EXPIRE_TIME:
                        # çœŸæ­£è§£ç¢¼ 0x02 ä¸¦ç™¼ä½ˆ
                        realtime_payload = decode_packet(pending_realtime_packet, 0x02)
                        publisher.publish_payload(device_id, 0x02, realtime_payload)

                        # âœ… åªå°ä¸€æ¢ä½ è¦çœ‹çš„ Info
                        logger.info(
                            "ğŸ“¡ BMS %d on line and realtime updated (delay %.2fs)",
                            device_id,
                            time_diff,
                        )

                        # ç´°ç¯€æ”¾åœ¨ DEBUG
                        logger.debug(
                            "é—œè¯ 0x02 å³æ™‚æ•¸æ“š â†’ device_id=%d (å»¶é² %.2fs, å·²ç™¼ä½ˆåˆ° MQTT)",
                            device_id,
                            time_diff,
                        )
                    else:
                        logger.debug(
                            "æš«å­˜ 0x02 å·²è¶…é %.2fsï¼Œæ¨æ£„ (å¯¦éš›å»¶é² %.2fs)",
                            PACKET_EXPIRE_TIME,
                            time_diff,
                        )
                    pending_realtime_packet = None
                else:
                    logger.debug("æ”¶åˆ° 0x01ï¼Œä½†ç›®å‰æ²’æœ‰æš«å­˜çš„ 0x02 å³æ™‚æ•¸æ“š")

            else:
                # æœªçŸ¥å°åŒ…å‹åˆ¥ç”¨ DEBUG è¨˜éŒ„ï¼Œå¹³å¸¸ä¸åµ
                logger.debug("æ”¶åˆ°æœªçŸ¥å°åŒ…å‹åˆ¥: %sï¼Œç•¥é", hex(pkt_type))

        except Exception as e:
            # éŒ¯èª¤æ™‚ä¸€å®šè¦çœ‹åˆ°ï¼Œæ‰€ä»¥ç”¨ ERROR
            if debug_raw_log:
                logger.error("main è™•ç†å°åŒ…ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
            else:
                logger.error("main è™•ç†å°åŒ…ç™¼ç”ŸéŒ¯èª¤: %s", e)


if __name__ == "__main__":
    main()
